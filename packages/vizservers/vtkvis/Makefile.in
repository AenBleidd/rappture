DEBUG			= #yes
TRACE			= #yes
USE_CUSTOM_AXES		= yes
USE_GPU_RAYCASTING	= yes
USE_OFFSCREEN_RENDERING	= #yes
USE_THREADS		= yes
USE_VTK6                = yes

bindir          = @bindir@
datadir         = @datadir@
datarootdir     = @datarootdir@
exec_prefix     = @exec_prefix@
includedir      = @includedir@
libdir          = @libdir@
mandir          = @mandir@
prefix          = @prefix@
srcdir          = @srcdir@

CC		= @CC@
CXX		= @CXX@
CFLAGS		= @CFLAGS@
CXXFLAGS	= @CXXFLAGS@

VPATH           = $(srcdir)

INSTALL         = @INSTALL@
INSTALL_PROGRAM = ${INSTALL} -m 0755
INSTALL_DATA    = ${INSTALL} -m 0644
INSTALL_SCRIPT  = ${INSTALL} -m 0644
MKDIR_P		= @MKDIR_P@

SVN_VERSION	= $(shell svnversion $(srcdir))
STATSDIR	= @STATSDIR@

GL_LIB_SPEC	= -lGL -lm
PTHREAD_LIB_SPEC= -lpthread

TCL_LIB_SPEC    = @TCL_LIB_SPEC@
TCL_INC_SPEC    = @TCL_INC_SPEC@

VTK_LIB_DIR	= @VTK_LIB_DIR@
VTK_LIB_SPEC	= -L$(VTK_LIB_DIR) \
		-lvtkChemistry \
		-lvtkIO \
		-lvtkWidgets \
		-lvtkFiltering \
		-lvtkVolumeRendering \
		-lvtkRendering \
		-lvtkHybrid \
		-lvtkGraphics \
		-lvtkImaging \
		-lvtkCommon
VTK_INC_SPEC	= @VTK_INC_SPEC@
VTK6_LIB_SPEC   = \
		-lvtkDomainsChemistry-6.0 \
		-lvtkIOCore-6.0 \
		-lvtkIOLegacy-6.0 \
		-lvtkFiltersModeling-6.0 \
		-lvtkFiltersFlowPaths-6.0 \
		-lvtkFiltersGeometry-6.0 \
		-lvtkFiltersSources-6.0 \
		-lvtkFiltersGeneral-6.0 \
		-lvtkFiltersCore-6.0 \
		-lvtkImagingHybrid-6.0 \
		-lvtkImagingCore-6.0 \
		-lvtkInteractionStyle-6.0 \
		-lvtkInteractionWidgets-6.0 \
		-lvtkRenderingOpenGL-6.0 \
		-lvtkRenderingHybridOpenGL-6.0 \
		-lvtkRenderingFreeTypeOpenGL-6.0 \
		-lvtkRenderingFreeType-6.0  \
		-lvtkRenderingVolumeOpenGL-6.0 \
		-lvtkRenderingVolume-6.0 \
		-lvtkRenderingLabel-6.0 \
		-lvtkRenderingAnnotation-6.0 \
		-lvtkRenderingCore-6.0 \
		-lvtkCommonCore-6.0 \
		-lvtkCommonDataModel-6.0 \
		-lvtkCommonExecutionModel-6.0  \
		-lvtkCommonMisc-6.0  \
		-lvtkCommonTransforms-6.0 \
		-lvtkCommonMath-6.0

ifdef USE_VTK6
VTK_LIB_SPEC	= $(VTK6_LIB_SPEC)
endif

ifdef USE_VTK6
LD_RUN_PATH	= $(libdir)
else
LD_RUN_PATH	= $(libdir):$(VTK_LIB_DIR)
endif

LIBS		= \
		$(TCL_LIB_SPEC) \
		$(VTK_LIB_SPEC) \
		$(GL_LIB_SPEC) \
		$(PTHREAD_LIB_SPEC) \
		-Wl,-rpath,$(LD_RUN_PATH) \
		-Wl,--enable-new-dtags

INCLUDES	= \
		-I$(srcdir) \
		$(TCL_INC_SPEC) \
		$(VTK_INC_SPEC)

#vtk uses deprecated strstream header (instead of sstream)
EXTRA_CXXFLAGS	= -Wall -Wno-deprecated
EXTRA_CFLAGS	= -Wall
DEFINES		= -DSVN_VERSION=\"$(SVN_VERSION)\" -DSTATSDIR=\"$(STATSDIR)\"
ifdef DEBUG
DEFINES 	+= -DDEBUG
CXXFLAGS	= -O0 -g
endif
ifdef TRACE
DEFINES		+= -DWANT_TRACE
endif
ifdef USE_CUSTOM_AXES
DEFINES 	+= -DUSE_CUSTOM_AXES
endif
ifdef USE_OFFSCREEN_RENDERING
DEFINES         += -DUSE_OFFSCREEN_RENDERING
endif
ifdef USE_GPU_RAYCASTING
DEFINES         += -DUSE_GPU_RAYCAST_MAPPER
endif
ifdef USE_THREADS
DEFINES         += -DUSE_THREADS
endif
ifdef USE_VTK6
VTK_MOD_DEFS    = -DvtkRenderingCore_AUTOINIT="4(vtkInteractionStyle,vtkRenderingFreeType,vtkRenderingFreeTypeOpenGL,vtkRenderingOpenGL)" -DvtkRenderingVolume_AUTOINIT"1(vtkRenderingVolumeOpenGL)"
DEFINES         += -DUSE_VTK6 $(VTK_MOD_DEFS)
endif

CXX_SWITCHES	= $(CXXFLAGS) $(EXTRA_CXXFLAGS) $(DEFINES) $(INCLUDES)
CC_SWITCHES	= $(CFLAGS) $(EXTRA_CFLAGS) $(DEFINES) $(INCLUDES)

SERVER_SRCS	= \
		Arc.cpp \
		Arrow.cpp \
		Box.cpp \
		CmdProc.cpp \
		ColorMap.cpp \
		Cone.cpp \
		Contour2D.cpp \
		Contour3D.cpp \
		Cutplane.cpp \
		Cylinder.cpp \
		DataSet.cpp \
		Disk.cpp \
		Glyphs.cpp \
		GraphicsObject.cpp \
		Group.cpp \
		HeightMap.cpp \
		LIC.cpp \
		Line.cpp \
		Molecule.cpp \
		Outline.cpp \
		PolyData.cpp \
		Polygon.cpp \
		PPMWriter.cpp \
		PseudoColor.cpp \
		ReadBuffer.cpp \
		Renderer.cpp \
		RendererCmd.cpp \
		RendererGraphicsObjs.cpp \
		RenderServer.cpp \
		Shape.cpp \
		Sphere.cpp \
		Streamlines.cpp \
		TGAWriter.cpp \
		Trace.cpp \
		Volume.cpp \
		Warp.cpp

ifdef USE_CUSTOM_AXES
SERVER_SRCS+= \
	vtkRpAxisActor.cpp \
	vtkRpAxisFollower.cpp \
	vtkRpCubeAxesActor.cpp
endif
ifdef USE_THREADS
SERVER_SRCS+=ResponseQueue.cpp
endif

SERVER_OBJS=$(SERVER_SRCS:.cpp=.o)
SERVER_OBJS+= md5.o
SERVER=vtkvis

.PHONY: all docs install clean clean-docs distclean

all: $(SERVER)

docs:
	$(MKDIR_P) -m 0755 docs/doxygen
	doxygen

$(SERVER): $(SERVER_OBJS)
	$(CXX) $(LIBS) -o $@ $(SERVER_OBJS)

install: all
	$(INSTALL_PROGRAM) $(SERVER) $(bindir)

%.o: %.cpp
	$(CXX) $(CXX_SWITCHES) -c $< -o $@

%.o: %.c
	$(CC) $(CC_SWITCHES) -c $< -o $@

clean:
	$(RM) *~ *.o $(SERVER)

clean-docs:
	$(RM) -r docs

distclean: clean clean-docs
	$(RM) Makefile Doxyfile

Arc.o: Arc.h Shape.h GraphicsObject.h DataSet.h Renderer.h Trace.h
Arrow.o: Arrow.h Shape.h GraphicsObject.h DataSet.h Renderer.h Trace.h
Box.o: Box.h Shape.h GraphicsObject.h DataSet.h Renderer.h Trace.h
CmdProc.o: CmdProc.h
ColorMap.o: ColorMap.h Molecule.h Trace.h
Cone.o: Cone.h Shape.h GraphicsObject.h DataSet.h Renderer.h Trace.h
Contour2D.o: Contour2D.h GraphicsObject.h DataSet.h Renderer.h Trace.h
Contour3D.o: Contour3D.h GraphicsObject.h DataSet.h Renderer.h ColorMap.h Trace.h
Cutplane.o: Cutplane.h GraphicsObject.h DataSet.h Renderer.h ColorMap.h Trace.h
Cylinder.o: Cylinder.h Shape.h GraphicsObject.h DataSet.h Renderer.h Trace.h
DataSet.o: DataSet.h Trace.h
Disk.o: Disk.h Shape.h GraphicsObject.h DataSet.h Renderer.h Trace.h
Glyphs.o: Glyphs.h GraphicsObject.h DataSet.h Renderer.h ColorMap.h Trace.h
GraphicsObject.o: GraphicsObject.h Renderer.h DataSet.h ColorMap.h Trace.h
Group.o: Group.h GraphicsObject.h DataSet.h Renderer.h Trace.h
HeightMap.o: HeightMap.h GraphicsObject.h DataSet.h Renderer.h ColorMap.h Trace.h
LIC.o: LIC.h GraphicsObject.h DataSet.h Renderer.h ColorMap.h Trace.h RenderServer.h
Line.o: Line.h Shape.h GraphicsObject.h DataSet.h Renderer.h Trace.h
md5.o: md5.h
Molecule.o: Molecule.h MoleculeData.h GraphicsObject.h DataSet.h Renderer.h ColorMap.h Trace.h
Outline.o: Outline.h GraphicsObject.h DataSet.h Trace.h
PolyData.o: PolyData.h GraphicsObject.h DataSet.h Renderer.h Trace.h
Polygon.o: Polygon.h Shape.h GraphicsObject.h DataSet.h Renderer.h Trace.h
PPMWriter.o: PPMWriter.h ResponseQueue.h Trace.h
PseudoColor.o: PseudoColor.h GraphicsObject.h DataSet.h Renderer.h ColorMap.h Trace.h
ReadBuffer.o: ReadBuffer.h Trace.h
Renderer.o: Renderer.h RendererGraphicsObjs.h vtkRpCubeAxesActor.h vtkRpAxisFollower.h vtkRpAxisActor.h Math.h DataSet.h Arc.h Arrow.h Box.h Cone.h Contour2D.h Contour3D.h Cutplane.h Cylinder.h Disk.h Glyphs.h Group.h HeightMap.h LIC.h Line.h Molecule.h Outline.h PolyData.h Polygon.h PseudoColor.h Sphere.h Streamlines.h Volume.h Warp.h ColorMap.h Trace.h
RendererCmd.o: Renderer.h RendererGraphicsObjs.h vtkRpCubeAxesActor.h vtkRpAxisFollower.h vtkRpAxisActor.h DataSet.h Arc.h Arrow.h Box.h Cone.h Contour2D.h Contour3D.h Cutplane.h Cylinder.h Disk.h Glyphs.h Group.h HeightMap.h LIC.h Line.h Molecule.h Outline.h PolyData.h Polygon.h PseudoColor.h Sphere.h Streamlines.h Volume.h Warp.h ColorMap.h ReadBuffer.h ResponseQueue.h Trace.h CmdProc.h PPMWriter.h TGAWriter.h
RendererGraphicsObjs.o: Renderer.h RendererGraphicsObjs.h DataSet.h Arc.h Arrow.h Box.h Cone.h Contour2D.h Contour3D.h Cutplane.h Cylinder.h Disk.h Glyphs.h Group.h HeightMap.h LIC.h Line.h Molecule.h Outline.h PolyData.h Polygon.h PseudoColor.h Sphere.h Streamlines.h Volume.h Warp.h ColorMap.h Trace.h
RenderServer.o: RenderServer.h RendererCmd.h Renderer.h vtkRpCubeAxesActor.h vtkRpAxisFollower.h vtkRpAxisActor.h ReadBuffer.h ResponseQueue.h Trace.h PPMWriter.h TGAWriter.h
ResponseQueue.o: ResponseQueue.h Trace.h
Shape.o: Shape.h GraphicsObject.h DataSet.h Renderer.h Trace.h
Sphere.o: Sphere.h Shape.h GraphicsObject.h DataSet.h Renderer.h Trace.h
Streamlines.o: Streamlines.h GraphicsObject.h DataSet.h Renderer.h ColorMap.h Trace.h
TGAWriter.o: TGAWriter.h ResponseQueue.h Trace.h
Trace.o: Trace.h
Volume.o: Volume.h GraphicsObject.h DataSet.h Renderer.h ColorMap.h Trace.h
vtkRpAxisActor.o: vtkRpAxisActor.h
vtkRpAxisFollower.o: vtkRpAxisFollower.h vtkRpAxisActor.h
vtkRpCubeAxesActor.o: vtkRpCubeAxesActor.h vtkRpAxisFollower.h vtkRpAxisActor.h
Warp.o: Warp.h GraphicsObject.h DataSet.h Renderer.h ColorMap.h Trace.h
