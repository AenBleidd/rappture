# Commands covered:
#   Rappture::GeoMapDataProviderWFS
#
# This file contains a collection of tests for one of the Rappture Tcl
# commands.  Sourcing this file into Tcl runs the tests and
# generates output for errors.  No output means no errors were found.
#
# ======================================================================
# AUTHOR:  Derrick Kearney, Purdue University
# Copyright (c) 2004-2015  HUBzero Foundation, LLC
#
# See the file "license.terms" for information on usage and redistribution
# of this file, and for a DISCLAIMER OF ALL WARRANTIES.


if {[lsearch [namespace children] ::tcltest] == -1} {
    package require tcltest
    package require RapptureGUI
    namespace import -force ::tcltest::*
}
catch {unset lib}

proc check {var size} {
    set l [llength $var]
    if {$l != $size} {
        return "length mismatch: should have been $size, was $l"
    }
    for {set i 0} {$i < $size} {set i [expr $i+1]} {
        set j [lindex $var $i]
        if {$j != "item $i"} {
            return "element $i should have been \"item $i\", was \"$j\""
        }
    }
    return ok
}

# temporary class for testing protected methods
itcl::class TestDataProviderWFS {
    inherit Rappture::GeoMapDataProviderWFS

    constructor {type url typename format args} {
        Rappture::GeoMapDataProviderWFS::constructor $type $url $typename $format
    } {
        eval configure $args
    }
    destructor {
        # empty
    }
    public method do { args } {eval $args}
}

#----------------------------------------------------------
#----------------------------------------------------------
# constructor command
# Rappture::GeoMapDataProviderWFS <name> <type> <url> <typename> <format>
#----------------------------------------------------------
test geomapdataproviderwfs-1.1 {Rappture::GeoMapDataProviderWFS, 0 arguments} {
    list [catch {Rappture::GeoMapDataProviderWFS} msg] $msg
} {0 {}}


test geomapdataproviderwfs-1.2 {Rappture::GeoMapDataProviderWFS, 1 arguments} {
    list [catch {Rappture::GeoMapDataProviderWFS name "line"} msg] $msg
} {1 {wrong # args: should be "::Rappture::GeoMapDataProviderWFS name type url typename format ?arg arg ...?"}}


test geomapdataproviderwfs-1.3 {Rappture::GeoMapDataProviderWFS, 2 arguments} {
    list [catch {Rappture::GeoMapDataProviderWFS name "line" "http://myurl.com/"} msg] $msg
} {1 {wrong # args: should be "::Rappture::GeoMapDataProviderWFS name type url typename format ?arg arg ...?"}}


test geomapdataproviderwfs-1.4 {Rappture::GeoMapDataProviderWFS, 2 arguments} {
    list [catch {Rappture::GeoMapDataProviderWFS name "line" "http://myurl.com/" "ns:fn"} msg] $msg
} {1 {wrong # args: should be "::Rappture::GeoMapDataProviderWFS name type url typename format ?arg arg ...?"}}


test geomapdataproviderwfs-1.5 {
    Rappture::GeoMapDataProviderWFS, name type url typename format
} -body {
    list [catch {Rappture::GeoMapDataProviderWFS name "line" "http://myurl.com/" "ns:fn" "json"} msg] $msg
} -cleanup {
    catch {itcl::delete object name} err
} -result {0 name}


#----------------------------------------------------------
# Type command
# $dp Type
# $dp Type <type>
#----------------------------------------------------------
test geomapdataproviderwfs-2.1 {Type, 0 arguments} {
    set dp [TestDataProviderWFS #auto "line" {http://myurl.com/} "ns:fs" "json"]
    list [catch {$dp do Type} msg] $msg
} {0 line}

test geomapdataproviderwfs-2.2 {Type, set type to "icon"} {
    set dp [TestDataProviderWFS #auto "line" {http://myurl.com/} "ns:fs" "json"]
    list [catch {$dp do Type "icon"} msg] $msg
} {0 icon}

test geomapdataproviderwfs-2.3 {Type, set type to "line"} {
    set dp [TestDataProviderWFS #auto "icon" {http://myurl.com/} "ns:fs" "json"]
    list [catch {$dp do Type "line"} msg] $msg
} {0 line}

test geomapdataproviderwfs-2.4 {Type, set type to "point"} {
    set dp [TestDataProviderWFS #auto "line" {http://myurl.com/} "ns:fs" "json"]
    list [catch {$dp do Type "point"} msg] $msg
} {0 point}

test geomapdataproviderwfs-2.5 {Type, set type to "polygon"} {
    set dp [TestDataProviderWFS #auto "line" {http://myurl.com/} "ns:fs" "json"]
    list [catch {$dp do Type "polygon"} msg] $msg
} {0 polygon}

test geomapdataproviderwfs-2.6 {Type, set type to "text"} {
    set dp [TestDataProviderWFS #auto "line" {http://myurl.com/} "ns:fs" "json"]
    list [catch {$dp do Type "text"} msg] $msg
} {0 text}

test geomapdataproviderwfs-2.7 {Type, set type to "image"} {
    set dp [TestDataProviderWFS #auto "line" {http://myurl.com/} "ns:fs" "json"]
    list [catch {$dp do Type "image"} msg] $msg
} {1 {bad value "image": should be one of "icon line point polygon text"}}

test geomapdataproviderwfs-2.8 {Type, set type to "elevation"} {
    set dp [TestDataProviderWFS #auto "line" {http://myurl.com/} "ns:fs" "json"]
    list [catch {$dp do Type "elevation"} msg] $msg
} {1 {bad value "elevation": should be one of "icon line point polygon text"}}

test geomapdataproviderwfs-2.9 {Type, set type to "feature"} {
    set dp [TestDataProviderWFS #auto "line" {http://myurl.com/} "ns:fs" "json"]
    list [catch {$dp do Type "feature"} msg] $msg
} {1 {bad value "feature": should be one of "icon line point polygon text"}}

test geomapdataproviderwfs-2.10 {Type, set type to "badname"} {
    set dp [TestDataProviderWFS #auto "line" {http://myurl.com/} "ns:fs" "json"]
    list [catch {$dp do Type "badname"} msg] $msg
} {1 {bad value "badname": should be one of "icon line point polygon text"}}

test geomapdataproviderwfs-2.11 {Type, set type to ""} {
    set dp [TestDataProviderWFS #auto "line" {http://myurl.com/} "ns:fs" "json"]
    list [catch {$dp do Type ""} msg] $msg
} {1 {bad value "": should be a non-empty string}}

test geomapdataproviderwfs-2.12 {Type, set type to "line" and retrieve type} {
    set dp [TestDataProviderWFS #auto "icon" {http://myurl.com/} "ns:fs" "json"]
    $dp do Type "line"
    list [catch {$dp do Type} msg] $msg
} {0 line}


#----------------------------------------------------------
# format command
# $dp format
# $dp format <name>
#----------------------------------------------------------
test geomapdataproviderwfs-3.1 {format, 0 arguments} {
    set dp [Rappture::GeoMapDataProviderWFS #auto "line" "http://myurl.com/" "ns:fs" "json"]
    list [catch {$dp format} msg] $msg
} {0 json}

test geomapdataproviderwfs-3.2 {format, 1 arguments} {
    set dp [Rappture::GeoMapDataProviderWFS #auto "line" "http://myurl.com/" "ns:fs" "json"]
    list [catch {$dp format "gml"} msg] $msg
} {0 gml}

test geomapdataproviderwfs-3.3 {format, empty string} {
    set dp [Rappture::GeoMapDataProviderWFS #auto "line" "http://myurl.com/" "ns:fs" "json"]
    list [catch {$dp format ""} msg] $msg
} {1 {bad value "": should be a non-empty string}}


#----------------------------------------------------------
# typename command
# $dp typename
# $dp typename <name>
#----------------------------------------------------------
test geomapdataproviderwfs-4.1 {typename, 0 arguments} {
    set dp [Rappture::GeoMapDataProviderWFS #auto "line" "http://myurl.com/" "ns:fs" "json"]
    list [catch {$dp typename} msg] $msg
} {0 ns:fs}

test geomapdataproviderwfs-4.2 {typename, 1 arguments} {
    set dp [Rappture::GeoMapDataProviderWFS #auto "line" "http://myurl.com/" "ns:fs" "json"]
    list [catch {$dp typename "ns1:fs1"} msg] $msg
} {0 ns1:fs1}

test geomapdataproviderwfs-4.3 {typename, empty string} {
    set dp [Rappture::GeoMapDataProviderWFS #auto "line" "http://myurl.com/" "ns:fs" "json"]
    list [catch {$dp typename ""} msg] $msg
} {1 {bad value "": should be a non-empty string}}


#----------------------------------------------------------
# exportToBltTree
# $dp exportToBltTree $tree
#----------------------------------------------------------

test geomapdataproviderwfs-3.1 {exportToBltTree, } {
    set dp [Rappture::GeoMapDataProviderWFS #auto "line" {http://myurl.com/} "ns:fs" "json"]
    set tree [blt::tree create]
    $dp exportToBltTree $tree
    $tree dump root
} {-1 0 ::tree0 {type line driver wfs cache true attribution {} wfs.url http://myurl.com/ wfs.typename ns:fs wfs.format json} {}
}


# TODO:

::tcltest::cleanupTests
return
